## 网络层

#### 任务

将**分组**从源端传送到目的端

网络层的传输单位是**数据报**

分组与数据报的关系：

分组是数据报的一个片段。。



#### 功能

- 路由的选择与分组转发
- 异构互联网络
- 拥塞控制



#### 数据交换方式

- 电路交换

  电话网络

  需事先建立连接，路径固定

- 报文交换

  报文：源应用发送的信息整体（pdf，图片等）

  无需建立连接，动态分配线路，因为对原始报文不进行切割，所以需要交换设备的缓存较大

- 分组交换

  类似报文交换，不同点在于分组交换会将报文进行切割

  相对于报文交换，存储管理更加容易（交换设备的缓存无需太大）

  缺点：

  - 有存储转发时延
  - 需要传输额外的信息量（源地址、目标地址、分组编号等）
  - 乱序到达时需要对分组进行排序重组





#### 传输单元名词辨析

| 应用层     | 报文                                                        |
| ---------- | ----------------------------------------------------------- |
| 传输层     | 报文段                                                      |
| 网络层     | IP数据报，分组（如果数据报大于数链层规定的MTU，则需要分组） |
| 数据链路层 | 帧                                                          |
| 物理层     | 比特流                                                      |

##### 路由算法

- 静态路由算法
- 动态路由算法
  - 路由器之间交换信息，按照算法有画出路由表项
  - 分类
    - 全局性：链路状态路由算法（OSPF)
    - 分散性：距离向量路由算法（RIP）
- 路由选择协议：
  - 内部网关协议IGP，一个自治系统（AS)内部使用，有OSPF，RIP协议
  - 外部网关协议EGP，AS之间使用，有BGP

##### IP数据报的分片过程

![image-20200218101631316](images\image-20200218101631316.png)

标识：表征这些分组属于同一个数据报

标志：表征是否分片，以及是否是最后一个分片

片偏移：表征当前分组在原数据报的相对位置





##### NAT

路由器不会转发**目的地址**是**私有IP**的数据报的

所以在专用网连接因特网的路由器上安装NAT软件，该路由器称之为**NAT路由器**，它至少有一个有效的外部全球IP地址,NAT路由器会依据**NAT转换表**将ip数据报进行转换，将目的ip为内网ip修改为外网ip，这样丢出去的数据报，就可以在路由器之间进行转发了

##### ARP协议

![image-20200218110812017](images\image-20200218110812017.png)

过程：

如果是同一网络内，1主机想跟3主机通信：

1. 主机1首先通过子网研发发现主机3与自己处于同一网络
2. 如果主机1在ARP高速缓存中没有查询到主机3的mac地址
3. 主机1先发送目的mac地址全F
4. 交换机发现这是一个广播分组，那么主机3收到后，返回ARP响应分组，告诉主机1自己的mac地址，ARP高速缓存信息也被更新
5. 主机1重新填入主机3的MAC地址，加上FCS（帧检验序列）组帧，然后发送

如果主机1与主机5通信（不在同一网络）：

1. 主机1先用自己的子网掩码与主机5相与，发现两者不在同一网络
2. 在ARP高速缓存中肯定是查不到主机5的MAC的，ARP高速缓存只存储本网络内的mac与ip的映射
3. 主机1发送的帧的目的ip、mac地址就是自己的默认网关ip、mac地址
4. 同上，如果ARP缓存中无，则先通过广播获取默认网关的mac地址
5. 得到之后，组帧源ip，mac都是自己，但是目标ip是ip5，目标mac是默认网关的mac

![image-20200218112822699](images\image-20200218112822699.png)

后序路由转发的过程中，**ip1与ip5自始至终都是不变的**，只有**源、目标的mac不断改变**



**ARP协议的四种情况：**

1. 主机A发送个本网络主机B：通过ARP找到主机B的MAC地址
2. 主机A发送另一网络主机B：通过ARP找到路由器（网关）的MAC地址
3. 路由器返送个本网络主机A：通过ARP找到A地址
4. 路由器发送给另一个网络主机B：通过ARP找到本网络的一个路由器的硬件地址